---
import BaseLayout from "src/layouts/BaseLayout.astro";
import client from "@data/client.json";
import { Image } from "astro:assets";
import CTA from "@components/CTA.astro";
import { getCollection } from "astro:content";
import { formatDate } from "@js/utils";
import FeaturedPost from "@components/FeaturedPost.astro";

const posts = await getCollection("blog");
posts.sort(
  (a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf(),
);
---

<BaseLayout title="Blog" description={"Blog Posts from " + client.name}>
  <!-- ============================================ -->
  <!--              Main Blog Content               -->
  <!-- ============================================ -->

  <div class="blog-container main-content-wrapper">
    <!--Main content -->
    <div class="main-content">
      <!-- ============================================ -->
      <!--                 Blog Articles                -->
      <!-- ============================================ -->
      {posts.length === 0 && <h1>No Recent Posts</h1>}
      {
        posts.length >= 1 &&
          posts.map((post) => (
            <article class="recent-articles">
              {post.data.image && (
                <picture class="blog-mainImage">
                  <Image
                    src={post.data.image}
                    alt={
                      post.data.imageAlt ? post.data.imageAlt : post.data.title
                    }
                    width={post.data.image.width}
                    height={post.data.image.height}
                    decoding="async"
                  />
                </picture>
              )}

              <div class="article-group">
                <div class="blog-authorGroup">
                  {post.data.author.map((author) => {
                    const [authorName, , authorImage] = author.split(/__|--/);
                    return (
                      <div>
                        <picture class="blog-author-img">
                          <img
                            src={
                              authorImage !== ""
                                ? "../" + authorImage
                                : "/assets/svgs/profile.svg"
                            }
                            alt={authorName}
                            width="32"
                            height="32"
                            decoding="async"
                          />
                        </picture>
                        <span class="blog-author">{authorName}</span>
                      </div>
                    );
                  })}
                  <span aria-hidden="true" class="blog-dot" />
                  <span class="blog-date">
                    {post.data.date && formatDate(post.data.date)}
                  </span>
                </div>
                <h2 class="blog-h1">{post.data.title}</h2>
                <p class="blog-desc">
                  {post.body
                    .split(" ")
                    .slice(0, 20)
                    .join(" ")
                    .replace(/[#*_\`]/g, "")
                    .replace(/\[([^\]]+)\]\([^\)]+\)/g, "$1")
                    .trim() + (post.body.split(" ").length > 20 && "...")}
                </p>
                <a href={post.slug} class="blog-link">
                  Continue Reading
                </a>
              </div>
            </article>
          ))
      }
    </div>
    <FeaturedPost />
  </div>
  <CTA />
</BaseLayout>
